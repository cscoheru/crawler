# 数据库设计文档

## 1. 概述

本文档描述爬虫数据管理与内容创作系统的数据库设计，包括表结构、索引优化和迁移策略。

---

## 2. 当前表结构

### 2.1 Article 表 (文章主表)

| 字段 | 类型 | 约束 | 描述 |
|------|------|------|------|
| id | Integer | PK, AutoIncrement | 主键 |
| source | String(50) | NOT NULL | 数据源 (zhihu/toutiao/wechat等) |
| article_id | String(100) | NOT NULL | 源平台文章ID |
| title | String(500) | NOT NULL | 文章标题 |
| content | Text | NOT NULL | 文章内容 |
| author | String(200) | NULL | 作者 |
| publish_time | DateTime | NULL | 发布时间 |
| url | Text | NULL | 文章链接 |
| category | String(50) | NULL | 一级分类 |
| subcategory | String(50) | NULL | 二级分类 |
| sub_subcategory | String(50) | NULL | 三级分类 |
| category_path | Text | NULL | 完整分类路径 (JSON字符串) |
| confidence | Float | DEFAULT 0.0 | 分类置信度 |
| quality_score | Float | DEFAULT 0.0 | 质量评分 |
| is_valid | Boolean | DEFAULT TRUE | 是否有效 |
| is_spam | Boolean | DEFAULT FALSE | 是否垃圾内容 |
| created_at | DateTime | DEFAULT NOW() | 创建时间 |
| updated_at | DateTime | DEFAULT NOW() | 更新时间 |

**索引**:
- `idx_source_article_id`: UNIQUE(source, article_id)
- `idx_category`: category
- `idx_publish_time`: publish_time
- `idx_quality_score`: quality_score

### 2.2 CrawlLog 表 (爬取日志)

| 字段 | 类型 | 约束 | 描述 |
|------|------|------|------|
| id | Integer | PK, AutoIncrement | 主键 |
| source | String(50) | NOT NULL | 数据源 |
| start_time | DateTime | NOT NULL | 开始时间 |
| end_time | DateTime | NULL | 结束时间 |
| success_count | Integer | DEFAULT 0 | 成功数量 |
| failed_count | Integer | DEFAULT 0 | 失败数量 |
| error_msg | Text | NULL | 错误信息 |
| created_at | DateTime | DEFAULT NOW() | 创建时间 |

**索引**:
- `idx_source_start_time`: (source, start_time)

### 2.3 Keyword 表 (关键词配置)

| 字段 | 类型 | 约束 | 描述 |
|------|------|------|------|
| id | Integer | PK, AutoIncrement | 主键 |
| category | String(50) | NOT NULL | 分类 |
| keyword | String(100) | NOT NULL | 关键词 |
| weight | Float | DEFAULT 1.0 | 权重 |

**索引**:
- `idx_category_keyword`: UNIQUE(category, keyword)

---

## 3. 新增表设计

### 3.1 CreatedArticle 表 (创作文章)

用于存储 AI 创作的文章。

| 字段 | 类型 | 约束 | 描述 |
|------|------|------|------|
| id | BIGINT | PK, AUTO_INCREMENT | 主键 |
| title | TEXT | NOT NULL | 文章标题 |
| content | TEXT | NOT NULL | 文章内容 |
| topic | TEXT | NOT NULL | 创作主题 |
| style | TEXT | NULL | 写作风格 |
| word_count | INTEGER | NULL | 字数 |
| reference_ids | JSONB | NULL | 参考文章ID列表 |
| export_formats | JSONB | NULL | 导出格式配置 |
| publish_status | TEXT | DEFAULT 'draft' | 发布状态 (draft/published) |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |

**索引**:
```sql
CREATE INDEX idx_created_articles_topic ON created_articles(topic);
CREATE INDEX idx_created_articles_status ON created_articles(publish_status);
CREATE INDEX idx_created_articles_created_at ON created_articles(created_at DESC);
```

### 3.2 TaskLog 表 (任务日志)

用于记录异步任务执行状态。

| 字段 | 类型 | 约束 | 描述 |
|------|------|------|------|
| id | BIGINT | PK, AUTO_INCREMENT | 主键 |
| task_type | TEXT | NOT NULL | 任务类型 (crawl/classify/sync/create) |
| task_id | TEXT | NULL | 任务ID (UUID) |
| status | TEXT | NOT NULL | 状态 (running/success/failed) |
| start_time | TIMESTAMPTZ | NOT NULL | 开始时间 |
| end_time | TIMESTAMPTZ | NULL | 结束时间 |
| result | JSONB | NULL | 结果数据 |
| error_msg | TEXT | NULL | 错误信息 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |

**索引**:
```sql
CREATE INDEX idx_task_logs_type ON task_logs(task_type);
CREATE INDEX idx_task_logs_status ON task_logs(status);
CREATE INDEX idx_task_logs_task_id ON task_logs(task_id);
CREATE INDEX idx_task_logs_start_time ON task_logs(start_time DESC);
```

---

## 4. 索引优化建议

### 4.1 当前索引分析

| 索引 | 使用场景 | 优化建议 |
|------|---------|---------|
| idx_source_article_id | 去重检查 | 保留，已优化 |
| idx_category | 按分类筛选 | 可改为部分索引 |
| idx_publish_time | 按时间排序 | 可添加 DESC |
| idx_quality_score | 按质量筛选 | 可改为部分索引 |

### 4.2 新增索引建议

#### 复合索引 (优化查询性能)

```sql
-- 分类 + 有效状态 + 质量排序 (常用查询组合)
CREATE INDEX idx_articles_category_valid ON articles(category, is_valid, quality_score DESC)
    WHERE is_valid = TRUE;

-- 数据源 + 质量排序 + 创建时间 (按数据源查询高质量文章)
CREATE INDEX idx_articles_source_quality ON articles(source, quality_score DESC, created_at DESC)
    WHERE quality_score >= 0.6 AND is_valid = TRUE;
```

#### 部分索引 (减少索引大小)

```sql
-- 仅索引高质量文章
CREATE INDEX idx_articles_high_quality ON articles(id, source, category, created_at DESC)
    WHERE quality_score >= 0.7 AND is_valid = TRUE;

-- 仅索引未分类文章
CREATE INDEX idx_articles_unclassified ON articles(id, title, content)
    WHERE category IS NULL OR category = '';
```

#### 全文搜索索引 (PostgreSQL)

```sql
-- 中文全文搜索
CREATE INDEX idx_articles_content_gin ON articles USING gin(to_tsvector('chinese', content));
CREATE INDEX idx_articles_title_gin ON articles USING gin(to_tsvector('chinese', title));

-- 组合全文搜索
CREATE INDEX idx_articles_fulltext_gin ON articles USING gin(
    to_tsvector('chinese', coalesce(title, '') || ' ' || coalesce(content, ''))
);
```

---

## 5. 数据库迁移策略

### 5.1 SQLite → PostgreSQL

当数据量增长时，建议迁移到 PostgreSQL：

**优势**:
- JSONB 字段支持
- 部分索引
- 全文搜索
- 更好的并发性能

**迁移步骤**:

```bash
# 1. 导出 SQLite 数据
python scripts/export_sqlite.py

# 2. 转换为 PostgreSQL 兼容格式
python scripts/convert_to_pg.py

# 3. 导入 PostgreSQL
psql -h host -U user -d database < data/export.pgsql

# 4. 更新环境变量
DATABASE_URL=postgresql://user:pass@host:5432/database
```

### 5.2 分区表 (大数据量)

当文章数超过 100 万时，考虑使用分区表：

```sql
-- 按月分区
CREATE TABLE articles_partitioned (
    id BIGINT,
    source VARCHAR(50),
    -- ... 其他字段
    created_at TIMESTAMPTZ DEFAULT NOW()
) PARTITION BY RANGE (created_at);

-- 创建分区
CREATE TABLE articles_2024_01 PARTITION OF articles_partitioned
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE articles_2024_02 PARTITION OF articles_partitioned
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
```

---

## 6. 数据完整性约束

### 6.1 检查约束

```sql
-- 质量评分范围
ALTER TABLE articles ADD CONSTRAINT check_quality_score
    CHECK (quality_score >= 0 AND quality_score <= 1);

-- 置信度范围
ALTER TABLE articles ADD CONSTRAINT check_confidence
    CHECK (confidence >= 0 AND confidence <= 1);

-- 发布状态枚举
ALTER TABLE created_articles ADD CONSTRAINT check_publish_status
    CHECK (publish_status IN ('draft', 'published'));
```

### 6.2 触发器

```sql
-- 自动更新 updated_at
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_articles_updated_at
    BEFORE UPDATE ON articles
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER trigger_created_articles_updated_at
    BEFORE UPDATE ON created_articles
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at();
```

---

## 7. 备份与恢复策略

### 7.1 备份策略

| 数据类型 | 备份频率 | 保留期限 | 存储位置 |
|---------|---------|---------|---------|
| 数据库 | 每日 | 30天 | Railway 内置备份 |
| 导出文件 | 实时 | 永久 | /data/exports |
| 日志文件 | 每日归档 | 90天 | /logs |

### 7.2 恢复流程

```bash
# 1. 停止应用
# 2. 恢复数据库
pg_restore -d database backup.dump

# 3. 验证数据
python scripts/verify_database.py

# 4. 重启应用
```

---

## 8. 性能优化建议

### 8.1 查询优化

| 优化项 | 说明 |
|--------|------|
| 使用 SELECT specific columns | 避免 SELECT * |
| 添加 LIMIT | 防止返回过多数据 |
| 使用 prepared statements | 防止 SQL 注入，提高性能 |
| 连接池配置 | pool_size=10, max_overflow=20 |

### 8.2 缓存策略

```python
# 应用层缓存 (内存或 Redis)
from functools import lru_cache

@lru_cache(maxsize=1000)
def get_statistics():
    # 缓存统计数据
    pass
```

---

**文档版本**: v1.0
**最后更新**: 2024-02-26
